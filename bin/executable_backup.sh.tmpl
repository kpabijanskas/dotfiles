#!/bin/bash
set -ex

rotate() {
    sync
    cp /Volumes/Backups/"$1"_backups/new_backup.sql /Volumes/Backups/"$1"_backups/latest_backup.sql
    sync
    rm /Volumes/Backups/"$1"_backups/new_backup.sql
}

# Postgresql
{{ .chezmoi.homeDir }}/bin/docker exec -u postgres postgresql pg_dumpall -c  > /Volumes/Backups/pg_backups/new_backup.sql
rotate pg

# Vaultwarden
tar czf /Volumes/Backups/vw_backups/new_backup.tar.gz {{ .chezmoi.homeDir }}/OrbStack/docker/volumes/vaultwarden_data
rotate vw

# Wallabag
tar czf /Volumes/Backups/wallabag_backups/new_backup.tar.gz {{ .chezmoi.homeDir }}/OrbStack/docker/volumes/wallabag_data
rotate wallabag

# Gitea
{{ .chezmoi.homeDir }}/bin/docker exec -u git gitea bash -c '/app/gitea/gitea dump -q -c /data/gitea/conf/app.ini --file="-" --type=tar.gz' > /Volumes/Backups/gitea_backups/new_backup.tar.gz
rotate gitea

# Nextcloud
tar czf /Volumes/Backups/nextcloud_backups/new_backup.tar.gz {{ .chezmoi.homeDir }}/OrbStack/docker/volumes/nextcloud_*
rotate nextcloud

# FreshRSS
tar czf /Volumes/Backups/freshrss_backups/new_backup.tar.gz {{ .chezmoi.homeDir }}/OrbStack/docker/volumes/freshrss_*
rotate freshrss

# Immich
tar czf /Volumes/Backups/immich_backups/new_backup.tar.gz {{ .chezmoi.homeDir }}/OrbStack/docker/volumes/immich_*
rotate immich

# Mealie
tar czf /Volumes/Backups/mealie_backups/new_backup.tar.gz {{ .chezmoi.homeDir }}/OrbStack/docker/volumes/mealie_*
rotate mealie

# Atuin
tar czf /Volumes/Backups/atuin_backups/new_backup.tar.gz {{ .chezmoi.homeDir }}/OrbStack/docker/volumes/atuin_*
rotate atuin
